// Link the provider and client, 
// load the db URL from the environment 
// variables using 'env()'

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// Hospital Module
model Hospital {
  id          String   @id @default(uuid())
  name        String
  address     String
  phone       String
  email       String   @unique
  latitude    Float?   // Hospital location
  longitude   Float?   // Hospital location
  
  // Operating hours (stored as JSON for flexibility)
  operatingHours Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  doctors     Doctor[]
  patients    Patient[]
  
  @@index([name])
  @@map("hospitals")
}



model Patient {
  id          String   @id @default(uuid())
  patientId   String   @unique
  email       String   @unique
  phone       String   @default("+1234567890") 
  name        String
  age         Int
  dateOfBirth DateTime
  term        Int
  dueDate     DateTime
  latitude    Float?
  longitude   Float?
  address     String?
  
  // Hospital relationship (REQUIRED)
  hospitalId  String
  hospital    Hospital @relation(fields: [hospitalId], references: [id], onDelete: Restrict)
  
  patientAssignments PatientAssignment[]
  readings           Reading[]
  notifications      Notification[]
  clinicalInfo       ClinicalInformation?
  appointments       Appointment[] // New: patient's appointments
  
  @@index([hospitalId])
  @@index([email])
}

model Doctor {
  id        String  @id @default(uuid())
  email     String  @unique
  phone     String  @default("+1234567890")
  name      String
  specialty String?
  
  // Hospital relationship (REQUIRED)
  hospitalId String
  hospital   Hospital @relation(fields: [hospitalId], references: [id], onDelete: Restrict)
  
  // Professional details
  licenseNumber     String?  // Medical license number
  yearsOfExperience Int?
  bio               String?  // Short bio for patients to read
  
  patientAssignments PatientAssignment[]
  notifications      Notification[]
  glucoseThresholds  GlucoseThresholds?
  appointments       Appointment[]        // New: doctor's appointments
  availabilitySlots  DoctorAvailability[] // New: doctor's availability schedule
  
  @@index([hospitalId])
  @@index([email])
}


model Appointment {
  id          String            @id @default(uuid())
  
  // Core relationships
  patientId   String
  patient     Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  doctorId    String
  doctor      Doctor            @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  
  // Appointment details
  appointmentDate DateTime        // Date and start time of appointment
  duration        Int             @default(50) // Duration in minutes
  endTime         DateTime        // Calculated end time
  
  status          AppointmentStatus @default(SCHEDULED)
  type            AppointmentType   @default(CONSULTATION)
  
  // Appointment notes
  reasonForVisit  String?         // Patient's reason for booking
  doctorNotes     String?         // Doctor's notes after appointment
  prescriptions   String?         // Prescriptions given
  
  // Metadata
  bookedAt        DateTime        @default(now())
  cancelledAt     DateTime?
  cancelReason    String?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([patientId, appointmentDate])
  @@index([doctorId, appointmentDate])
  @@index([status])
  @@unique([doctorId, appointmentDate], name: "unique_doctor_appointment_time")
  @@map("appointments")
}

model DoctorAvailability {
  id          String   @id @default(uuid())
  
  doctorId    String
  doctor      Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  
  // Time slot details
  dayOfWeek   DayOfWeek        // Which day of the week
  startTime   String           // Format: "HH:MM" (e.g., "09:00")
  endTime     String           
  
  // For specific date overrides (e.g., holidays, sick days)
  specificDate DateTime?       // If set, this applies to a specific date only
  isAvailable  Boolean         @default(true) // false = blocked time
  
  // Recurrence
  isRecurring  Boolean         @default(true) // Does this repeat every week?
  effectiveFrom DateTime       @default(now())
  effectiveUntil DateTime?     // Optional end date for availability
  
  // Notes
  notes        String?         // E.g., "On vacation", "Conference"
  
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  
  @@index([doctorId, dayOfWeek])
  @@index([doctorId, specificDate])
  @@map("doctor_availability")
}


model ClinicalInformation {
  id                    String   @id @default(uuid())
  patientId             String   @unique
  
  nationality           String?
  bmi                   Float?
  weight                Float?
  height                Float?
  weightGainDuringPregnancy Float?
  fastingBloodGlucose   Float?
  oneHour75Glucose      Float?
  twoHour75Glucose      Float?
  hypertensiveDisorders String?
  pulseHeartRate        Float?
  bpSystolic            Float?
  bpDiastolic           Float?
  
  aiPredictions         GDMPrediction[]
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  patient               Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
  @@map("clinical_information")
}

model GDMPrediction {
  id                    String   @id @default(uuid())
  clinicalInfoId        String
  
  predictedGDMRisk      Float
  riskCategory          GDMRiskLevel
  confidence            Float
  
  modelVersion          String
  featuresUsed          Json
  topInfluentialFeatures String[]
  
  predictedAt           DateTime @default(now())
  isActive              Boolean  @default(true)
  
  clinicalInformation   ClinicalInformation @relation(fields: [clinicalInfoId], references: [id], onDelete: Cascade)
  
  @@index([clinicalInfoId, isActive])
  @@index([predictedAt])
  @@index([riskCategory])
  @@map("gdm_predictions")
}

model PatientAssignment {
  id            String   @id @default(uuid())
  doctorId      String
  patientId     String
  lastVisitDate DateTime
  addedDate     DateTime
  
  hasMessageForDoctor  Boolean @default(false)
  hasMessageForPatient Boolean @default(false)
  
  doctor          Doctor          @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient         Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  messages        Message[]
  recommendations Recommendation[]
}

model Recommendation {
  id                  String   @id @default(uuid())
  patientAssignmentId String
  title               String
  description         String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  isActive            Boolean  @default(true)
  
  patientAssignment PatientAssignment @relation(fields: [patientAssignmentId], references: [id], onDelete: Cascade)
  
  @@index([patientAssignmentId])
}

model Reading {
  id        String      @id @default(uuid())
  patientId String
  date      DateTime
  time      String
  type      ReadingType
  level     Float
  status    ReadingStatus @default(NORMAL)
  notes     String?
  
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@unique([patientId, date, type], name: "unique_patient_date_type")
  @@index([patientId, date])
}

model Message {
  id                  String     @id @default(uuid())
  patientAssignmentId String
  senderId            String
  senderType          SenderType
  content             String
  timestamp           DateTime   @default(now())
  isRead              Boolean    @default(false)
  
  patientAssignment PatientAssignment @relation(fields: [patientAssignmentId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  content   String
  metadata  Json?
  isRead    Boolean          @default(false)
  isArchived Boolean         @default(false)
  createdAt DateTime         @default(now())
  readAt    DateTime?
  
  patientId String?
  doctorId  String?
  
  patient Patient? @relation(fields: [patientId], references: [id])
  doctor  Doctor?  @relation(fields: [doctorId], references: [id])
  
  @@index([patientId, isRead, isArchived])
  @@index([doctorId, isRead, isArchived])
  @@index([createdAt])
  @@map("notifications")
}

model GlucoseThresholds {
  id        String   @id @default(uuid())
  doctorId  String   @unique
  
  hyperglycemiaBeforeMeal    Float @default(95)
  hyperglycemiaAfterMeal     Float @default(140)
  hyperglycemiaMajor         Float @default(180)
  
  hypoglycemia               Float @default(70)
  hypoglycemiaMajor          Float @default(54)
  
  frequentThreshold          Int   @default(3)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  doctor    Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  
  @@map("glucose_thresholds")
}

enum NotificationType {
  DANGEROUS_READING
  NEW_MESSAGE
  NEW_RECOMMENDATION
  DAILY_REMINDER
  APPOINTMENT_REMINDER    // remind about upcoming appointment
  APPOINTMENT_CANCELLED   // appointment was cancelled
  APPOINTMENT_CONFIRMED   // appointment was confirmed
}

enum SenderType {
  DOCTOR
  PATIENT
}

enum ReadingType {
  BEFORE_BREAKFAST
  AFTER_BREAKFAST
  BEFORE_LUNCH
  AFTER_LUNCH
  BEFORE_DINNER
  AFTER_DINNER
}

enum ReadingStatus {
  NORMAL
  HIGH
  ELEVATED
}

enum GDMRiskLevel {
  LOW
  MODERATE
  HIGH
  CRITICAL
}

enum AppointmentStatus {
  SCHEDULED      // Appointment is booked and confirmed
  COMPLETED      // Appointment happened
  CANCELLED      // Cancelled by patient or doctor
  NO_SHOW        // Patient didn't show up
  RESCHEDULED    // Appointment was rescheduled
}

enum AppointmentType {
  CONSULTATION   // Regular checkup
  FOLLOW_UP      // Follow-up appointment
  EMERGENCY      // Emergency appointment
  LAB_REVIEW     // Review lab results
  INITIAL        // First appointment
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}